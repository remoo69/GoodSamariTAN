{% extends 'landingPage.html' %}
{% load static %}

{% block content %}
{% include 'nav.html' %}

<div class="max-w-3xl mx-auto mt-10 px-4 sm:px-6 lg:px-8 mb-20">
    <h1 class="text-3xl font-bold text-slate-800 mb-6">NGO Application</h1>
    <form method="post" action="{% url 'ngo_application_submit' %}" enctype="multipart/form-data" class="bg-white p-6 rounded-md shadow-md">
        {% csrf_token %}

        {% if error %}
        <div class="mb-4">
            <p style="color: red; font-weight: text-sm;">{{ error }}</p>
        </div>
        {% endif %}

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Employer Identification Number (EIN)</label>
            <input type="text" name="ein" id="id_ein" required class="w-full mt-2 px-4 py-2 border rounded-md">
            <span id="ein_error" style="color: red;"></span>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Organizationâ€™s Name</label>
            <input type="text" name="name" id="id_name" required class="w-full mt-2 px-4 py-2 border rounded-md">
            <span id="name_error" style="color: red;"></span>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Physical Address</label>
            <textarea name="address" required class="w-full mt-2 px-4 py-2 border rounded-md"></textarea>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Contact Number</label>
            <input type="text" name="contact_number" required class="w-full mt-2 px-4 py-2 border rounded-md">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Organization Email</label>
            <input type="email" name="email" id="id_email" required class="w-full mt-2 px-4 py-2 border rounded-md">
            <span id="email_error" style="color: red;"></span>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" name="password" required class="w-full mt-2 px-4 py-2 border rounded-md">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
            <input type="password" name="confirm_password" required class="w-full mt-2 px-4 py-2 border rounded-md">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Upload IRS Form 990</label>
            <input type="file" name="form_990" required class="w-full mt-2 px-4 py-2 border rounded-md">
        </div>
        <button type="submit" class="w-full sm:w-auto px-5 py-2 bg-slate-500 text-white rounded-md hover:bg-slate-600">
            Submit Application
        </button>
    </form>
</div>

{% include 'footer.html' %}
{% endblock %}

<script>
function checkUniqueField(fieldName, value) {
    // Sending AJAX request to check uniqueness
    fetch(`/check_unique/?${fieldName}=${value}`)
        .then(response => response.json())
        .then(data => {
            // Check response and show error message
            if (fieldName === 'ein') {
                const einError = document.getElementById('ein_error');
                if (data.ein_exists) {
                    einError.textContent = "This EIN is already registered.";
                } else {
                    einError.textContent = "";
                }
            } else if (fieldName === 'name') {
                const nameError = document.getElementById('name_error');
                if (data.name_exists) {
                    nameError.textContent = "This organization name is already taken.";
                } else {
                    nameError.textContent = "";
                }
            } else if (fieldName === 'email') {
                const emailError = document.getElementById('email_error');
                if (data.email_exists) {
                    emailError.textContent = "This email address is already registered.";
                } else {
                    emailError.textContent = "";
                }
            }
        });
}

document.getElementById('id_ein').addEventListener('blur', function() {
    checkUniqueField('ein', this.value);
});

document.getElementById('id_name').addEventListener('blur', function() {
    checkUniqueField('name', this.value);
});

document.getElementById('id_email').addEventListener('blur', function() {
    checkUniqueField('email', this.value);
});
</script>
